<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< HEAD
    <title>CardWay - é¸æ“‡æœå‹™</title>
    <style>
=======
    <title>CardWay | æ—¥æ—…ç¥å¡æ”»ç•¥ (ç†Šæœ¬ç†Š/å‰é¶´/æ˜Ÿå±•)</title>
    <!-- å¼•å…¥ Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Outfit:wght@400;600&display=swap"
        rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* é…è‰²ä¸»é¡Œ */
            --primary: #DC2626;
            /* ç†Šæœ¬ç†Šç´… */
            --secondary: #BE123C;
            /* å‰é¶´æ·±ç´… */
            --eco: #0D9488;
            /* æ˜Ÿå±• Eco ç¶  (Teal) */

            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --danger: #EF4444;
            --warning: #F59E0B;
            --success: #10B981;
            --tag-bg: #FEF2F2;
            --tag-text: #991B1B;
            --ai-color: #7C3AED;
            --ai-bg: #F3E8FF;
        }

>>>>>>> 35505d92eda3e38170e39b884881a0476f1cf2b0
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
<<<<<<< HEAD
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            padding: 48px 32px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #1a202c;
            margin-bottom: 12px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 32px;
            font-size: 14px;
        }

        .service-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: block;
            border: 2px solid transparent;
        }

        .service-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .service-card .icon {
            font-size: 36px;
            margin-bottom: 12px;
            display: block;
        }

        .service-card h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .service-card p {
            color: #718096;
            font-size: 13px;
            line-height: 1.5;
        }

        .primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .primary h2,
        .primary p {
            color: white;
=======
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', 'Noto Sans TC', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            padding-bottom: 100px;
        }

        .header {
            background: var(--surface);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary);
        }

        .brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand i {
            color: var(--primary);
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* AI Button in Header */
        .ai-header-btn {
            background: linear-gradient(135deg, #7C3AED, #DB2777);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(124, 58, 237, 0.3);
            animation: pulse 2s infinite;
        }

        /* Settings Button */
        .settings-btn {
            background: #F3F4F6;
            color: var(--text-main);
            border: 1px solid var(--border);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(124, 58, 237, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(124, 58, 237, 0);
            }
        }

        /* Card Styles */
        .card-target {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        /* Specific Styles for Card Types */
        .card-target[data-type="ç†Šæœ¬ç†Š"] {
            border-left: 5px solid #EF4444;
        }

        .card-target[data-type="å‰é¶´å¡"] {
            border-left: 5px solid #BE123C;
        }

        .card-target[data-type="æ˜Ÿå±• eco å¡"] {
            border-left: 5px solid #0D9488;
            /* Teal */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-title-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-type-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .period-tag {
            display: inline-block;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--tag-bg);
            color: var(--tag-text);
            font-weight: 600;
            width: fit-content;
        }

        .advisor-note {
            background: #F9FAFB;
            border-left: 3px solid var(--text-sub);
            padding: 8px 12px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-sub);
            line-height: 1.5;
            border-radius: 0 4px 4px 0;
        }

        .advisor-note strong {
            color: var(--text-main);
            display: block;
            margin-bottom: 2px;
        }

        .delete-btn {
            color: #9CA3AF;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .delete-btn:hover {
            color: var(--danger);
        }

        /* Progress Bar */
        .progress-section {
            margin: 16px 0;
        }

        .progress-bar-bg {
            background: #E5E7EB;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
        }

        /* Custom progress bar colors based on card type context if needed, 
           currently using generic logic in JS */

        .stats-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
        }

        .current-spend {
            font-size: 28px;
            font-weight: 800;
            margin: 4px 0;
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
        }

        .currency {
            font-size: 16px;
            color: var(--text-sub);
            font-weight: 500;
        }

        /* Inputs */
        .action-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            border-top: 1px solid var(--bg);
            padding-top: 16px;
        }

        .amount-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .amount-input:focus {
            border-color: var(--primary);
        }

        .btn {
            padding: 0 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-add {
            background: var(--primary);
            color: white;
        }

        .btn-sub {
            background: #FEE2E2;
            color: var(--danger);
        }

        .btn-outline {
            border: 1px solid var(--border);
            background: white;
            color: var(--text-main);
        }

        /* Floating Add Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: var(--text-main);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 90;
            transition: transform 0.2s;
        }

        .fab:hover {
            transform: rotate(90deg);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: white;
            padding: 24px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal h2 {
            margin-bottom: 20px;
            font-size: 20px;
            color: var(--text-main);
        }

        .preset-category {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-sub);
            margin: 12px 0 8px;
            padding-left: 4px;
        }

        .preset-group {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
        }

        .preset-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preset-btn:hover {
            border-color: var(--primary);
            background: #FEF2F2;
        }

        .preset-icon {
            width: 32px;
            height: 32px;
            background: #F3F4F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
        }

        .preset-info h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .preset-info p {
            font-size: 12px;
            color: var(--text-sub);
        }

        .divider {
            text-align: center;
            margin: 16px 0;
            font-size: 12px;
            color: var(--text-sub);
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .form-label {
            display: block;
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 6px;
            margin-top: 12px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
        }

        textarea.form-input {
            font-family: monospace;
            font-size: 12px;
            min-height: 100px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-full {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
        }

        .btn-cancel {
            background: #F3F4F6;
            color: var(--text-main);
        }

        /* AI Chat Styles */
        .ai-chat-container {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-message {
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .ai-message.user {
            background: #F3F4F6;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            max-width: 85%;
        }

        .ai-message.bot {
            background: var(--ai-bg);
            color: #4C1D95;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            max-width: 95%;
            border: 1px solid #E9D5FF;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-sub);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #D1D5DB;
>>>>>>> 35505d92eda3e38170e39b884881a0476f1cf2b0
        }
    </style>
</head>

<body>
<<<<<<< HEAD
    <div class="container">
        <h1>ğŸ´ CardWay</h1>
        <p class="subtitle">è«‹é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„æœå‹™</p>

        <a href="./src/cardlimit/" class="service-card primary">
            <span class="icon">âœˆï¸</span>
            <h2>æ—¥æ—…ç¥å¡æ”»ç•¥</h2>
            <p>ç†Šæœ¬ç†Šã€å‰é¶´ã€æ˜Ÿå±• eco é¡åº¦ç®¡ç† + AI æ¶ˆè²»å»ºè­°</p>
        </a>

        <a href="./src/line-liff-login/" class="service-card">
            <span class="icon">ğŸ’³</span>
            <h2>CardWay LIFF</h2>
            <p>å®Œæ•´çš„ä¿¡ç”¨å¡ç®¡ç†ç³»çµ±ï¼ˆéœ€é€é LINE ç™»å…¥ï¼‰</p>
        </a>
    </div>
=======

    <div class="header">
        <div class="brand">
            <i class="fas fa-plane-departure"></i>
            <div>
                æ—¥æ—…ç¥å¡æ”»ç•¥
            </div>
        </div>
        <div class="header-actions">
            <button class="ai-header-btn" onclick="openAIModal()">
                <i class="fas fa-sparkles"></i> AI
            </button>
            <button class="settings-btn" onclick="openSettingsModal()">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <div class="container" id="cards-container">
        <!-- Cards will be injected here -->
    </div>

    <!-- FAB -->
    <div class="fab" onclick="openAddModal()">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Add Card Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal">
            <h2>æ–°å¢æ”»ç•¥é …ç›®</h2>

            <div class="form-label">å¿«é€Ÿé¸æ“‡ (é¡§å•ç²¾é¸)</div>
            <div id="preset-list">
                <!-- Presets injected via JS -->
            </div>

            <div class="divider">æˆ–è‡ªè¨‚é …ç›®</div>

            <label class="form-label">å¡ç‰‡æ­¸å±¬</label>
            <select id="input-category" class="form-input">
                <option value="ç†Šæœ¬ç†Š">ğŸ» ç†Šæœ¬ç†Šå¡</option>
                <option value="å‰é¶´å¡">ğŸª¿ å‰é¶´å¡</option>
                <option value="æ˜Ÿå±• eco å¡">ğŸŒ± æ˜Ÿå±• eco å¡</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>

            <label class="form-label">é …ç›®åç¨±</label>
            <input type="text" id="input-name" class="form-input" placeholder="ä¾‹å¦‚ï¼šè‡ªè¨‚æ´»å‹•">

            <label class="form-label">ä¸Šé™é‡‘é¡ (NT$)</label>
            <input type="number" id="input-limit" class="form-input" placeholder="0" inputmode="numeric">

            <label class="form-label">é€±æœŸæ¨™ç±¤</label>
            <select id="input-period" class="form-input">
                <option value="æ¯æœˆ">æ¯æœˆé‡ç½®</option>
                <option value="æ¯å­£">æ¯å­£é‡ç½®</option>
                <option value="æ´»å‹•æœŸé–“">æ´»å‹•æœŸé–“ (ä¸€æ¬¡æ€§)</option>
            </select>

            <label class="form-label">é¡§å•é»è©•/å‚™è¨»</label>
            <input type="text" id="input-note" class="form-input" placeholder="ç°¡çŸ­å‚™è¨» (é¸å¡«)">

            <div class="modal-actions">
                <button class="btn btn-full btn-cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="btn btn-full btn-add" onclick="addCustomCard()">æ–°å¢è‡ªè¨‚</button>
            </div>
        </div>
    </div>

    <!-- Settings/Backup Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h2><i class="fas fa-save"></i> è³‡æ–™ç®¡ç†</h2>
            <p style="font-size:13px; color:var(--text-sub); margin-bottom:16px;">
                è³‡æ–™ç›®å‰è‡ªå‹•å„²å­˜æ–¼æ­¤ç€è¦½å™¨ã€‚
            </p>

            <!-- API Key Section for Zeabur/Static/Local -->
            <div id="apikey-section" style="margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid #E5E7EB;">
                <label class="form-label" style="color:var(--primary); font-weight:700;">ğŸ”‘ Gemini API Key è¨­å®š</label>
                <div style="font-size:12px; color:var(--text-sub); margin-bottom:8px;">
                    è‹¥éä½¿ç”¨ GAS éƒ¨ç½² (å¦‚ Zeabur)ï¼Œè«‹åœ¨æ­¤å¡«å…¥ Keyã€‚
                </div>
                <input type="password" id="input-apikey" class="form-input" placeholder="AIzaSy..."
                    onchange="saveApiKey()">
            </div>

            <label class="form-label">åŒ¯å‡ºå‚™ä»½ (è¤‡è£½æ­¤ä»£ç¢¼ä¿å­˜)</label>
            <textarea id="export-area" class="form-input" readonly onclick="this.select()"></textarea>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-full btn-add" onclick="copyExportData()">
                    <i class="fas fa-copy" style="margin-right:8px;"></i> è¤‡è£½ä»£ç¢¼
                </button>
            </div>

            <div class="divider">é‚„åŸè³‡æ–™</div>

            <label class="form-label">åŒ¯å…¥å‚™ä»½ (è²¼ä¸Šä»£ç¢¼)</label>
            <input type="text" id="import-input" class="form-input" placeholder="åœ¨æ­¤è²¼ä¸Šå‚™ä»½ä»£ç¢¼...">
            <button class="btn btn-full btn-outline" onclick="importData()">
                <i class="fas fa-file-import" style="margin-right:8px;"></i> è¼‰å…¥å‚™ä»½
            </button>

            <div class="divider">å±éšªå€åŸŸ</div>
            <button class="btn btn-full btn-sub" onclick="clearAllData()">
                <i class="fas fa-trash-alt" style="margin-right:8px;"></i> æ¸…é™¤æ‰€æœ‰è³‡æ–™
            </button>

            <div class="modal-actions">
                <button class="btn btn-full btn-cancel" onclick="closeSettingsModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- AI Modal -->
    <div class="modal-overlay" id="ai-modal">
        <div class="modal">
            <h2 style="display:flex; align-items:center; gap:8px;">
                <i class="fas fa-sparkles" style="color:#7C3AED;"></i>
                AI æ¶ˆè²»é¡§å•
            </h2>
            <p style="font-size:13px; color:var(--text-sub); margin-bottom:16px;">
                è¼¸å…¥ä½ æƒ³è²·çš„æ±è¥¿èˆ‡é‡‘é¡ï¼ŒAI æœƒæ¯”è¼ƒã€Œç†Šæœ¬ç†Šã€å‰é¶´ã€æ˜Ÿå±• ecoã€çš„å„ªæƒ ï¼Œä¸¦æ ¹æ“šæ‚¨ç›®å‰çš„é¡åº¦ç‹€æ…‹æä¾›å»ºè­°ã€‚
            </p>

            <div class="ai-chat-container" id="ai-response-area">
                <!-- Chat history -->
            </div>

            <div style="margin-top:16px; display:flex; gap:8px;">
                <input type="text" id="ai-input" class="form-input" style="margin-bottom:0;"
                    placeholder="ä¾‹ï¼šåœ¨ UNIQLO è²·è¡£æœ 3000 å…ƒ">
                <button class="btn btn-add" style="background:#7C3AED; padding:0 16px;" onclick="askGemini()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <div class="modal-actions">
                <button class="btn btn-full btn-cancel" onclick="closeAIModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // Global Error Handler for Mobile Debugging
        window.onerror = function (msg, url, line, col, error) {
            // alert("JS Error: " + msg + "\nLine: " + line); // Disable for production
            return false;
        };

        // Gemini API Configuration
        let apiKey = "<?!= apiKey ?>";

        // 1. Try generic check for GAS tag
        if (apiKey.indexOf("<" + "?") !== -1 || !apiKey) {
            apiKey = "";
        }

        // 2. Load from LocalStorage (Priority for Zeabur/Static)
        const localKey = localStorage.getItem('gemini_api_key');
        if (localKey) {
            apiKey = localKey;
        }

        function saveApiKey() {
            const val = document.getElementById('input-apikey').value.trim();
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                apiKey = val;
                alert("API Key å·²å„²å­˜ï¼");
            }
        }

        // On Open Settings, fill the input
        function initSettingsUI() {
            const stored = localStorage.getItem('gemini_api_key');
            if (stored && document.getElementById('input-apikey')) {
                document.getElementById('input-apikey').value = stored;
            }
        }

        // 2026 æ¬Šç›Šé è¨­è³‡æ–™ (ç†Šæœ¬ç†Š + å‰é¶´ + æ˜Ÿå±•eco)

        // 2026 æ¬Šç›Šé è¨­è³‡æ–™ (ç†Šæœ¬ç†Š + å‰é¶´ + æ˜Ÿå±•eco)
        const PRESETS_DATA = {
            "ç†Šæœ¬ç†Šå¡": [
                {
                    name: "ğŸ‡¯ğŸ‡µ æŒ‡å®šé€šè·¯ (Suica/è—¥å¦)",
                    limit: 8333,
                    period: "æ¯æœˆ",
                    icon: "fa-torii-gate",
                    note: "å›é¥‹8.5%ã€‚è¶…éå¾Œé™ç‚º2.5%ã€‚"
                },
                {
                    name: "ğŸ‡¯ğŸ‡µ PayPay æƒç¢¼ (ç‰å±±Wallet)",
                    limit: 2857,
                    period: "æ¯å­£",
                    icon: "fa-qrcode",
                    note: "å›é¥‹5%ã€‚é¡åº¦æ¥µä½(å­£é™$100)ï¼Œå»ºè­°åƒ…ç”¨æ–¼ä¸èƒ½åˆ·å¡çš„å°åº—ã€‚"
                },
                {
                    name: "ğŸ‡¹ğŸ‡¼ æ‚ éŠå¡è‡ªå‹•åŠ å€¼",
                    limit: 500,
                    period: "æ¯æœˆ",
                    icon: "fa-train",
                    note: "å›é¥‹10%ã€‚é™ã€Œå¾ˆå‹å¥½ã€ç‰ˆã€‚è‡ªå‹•åŠ å€¼ä¸€æ¬¡(500å…ƒ)å³æ»¿ã€‚"
                }
            ],
            "å‰é¶´å¡": [
                {
                    name: "ğŸ‡¯ğŸ‡µ Apple Pay (QUICPay)",
                    limit: 40000,
                    period: "æ¯æœˆ",
                    icon: "fa-mobile-alt",
                    note: "ç™»éŒ„åŠ ç¢¼1.5%(ç¸½4%)ã€‚ä¸Šé™$600/æœˆã€‚éœ€ç¶å®šQUICPayã€‚"
                },
                {
                    name: "ğŸ‡¹ğŸ‡¼ åœ‹å…§æ—¥ç³»ååº— (UNIQLO/å¤§å‰µ)",
                    limit: 12500,
                    period: "æ¯æœˆ",
                    icon: "fa-tshirt",
                    note: "åŠ ç¢¼4%(ç¸½5%)ã€‚ä¸Šé™$500/æœˆã€‚é©åˆè²·è¡£æœæ—¥ç”¨å“ã€‚"
                },
                {
                    name: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬ç†±é–€å•†åº— (åŠå¹´åˆ¶)",
                    limit: 20000,
                    period: "æ´»å‹•æœŸé–“",
                    icon: "fa-store",
                    note: "åŠ ç¢¼3%ã€‚2026ä¸ŠåŠå¹´ç¸½é¡åº¦2è¬å°å¹£ã€‚åŒ…å«æŒ‡å®šè¶…å•†/è—¥å¦/æ¨‚åœ’ã€‚"
                }
            ],
            "æ˜Ÿå±• eco å¡": [
                {
                    name: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬å¯¦é«”æ¶ˆè²» (å«Apple Pay)",
                    limit: 15000,
                    period: "æ¯æœˆ",
                    icon: "fa-credit-card",
                    note: "å›é¥‹5%ã€‚é™å¯¦é«”åˆ·å¡/Apple Payã€‚ä¸Šé™600é»(åˆ·1.5è¬)ã€‚"
                }
            ]
        };

        // State
        let cards = [];

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadCards();
            renderPresets();
            renderCards();
        });

        function loadCards() {
            const stored = localStorage.getItem('japan_travel_cards_2026');
            if (stored) {
                cards = JSON.parse(stored);
            } else {
                // é è¨­ä¸è¼‰å…¥ä»»ä½•å¡ç‰‡ï¼Œè®“ä½¿ç”¨è€…è‡ªå·±é¸
                saveCards();
            }
        }

        function saveCards() {
            localStorage.setItem('japan_travel_cards_2026', JSON.stringify(cards));
            renderCards();
        }

        function renderPresets() {
            const list = document.getElementById('preset-list');
            list.innerHTML = '';

            for (const [category, presets] of Object.entries(PRESETS_DATA)) {
                let catIcon = 'ğŸ’³';
                if (category === 'ç†Šæœ¬ç†Šå¡') catIcon = 'ğŸ»';
                else if (category === 'å‰é¶´å¡') catIcon = 'ğŸª¿';
                else if (category === 'æ˜Ÿå±• eco å¡') catIcon = 'ğŸŒ±';

                let html = `<div class="preset-category">${catIcon} ${category}</div><div class="preset-group">`;

                html += presets.map(p => `
                    <div class="preset-btn" onclick="addPreset('${category}', '${p.name}', ${p.limit}, '${p.period}', '${p.note}')">
                        <div class="preset-icon"><i class="fas ${p.icon}"></i></div>
                        <div class="preset-info">
                            <h4>${p.name}</h4>
                            <p>ä¸Šé™ $${p.limit.toLocaleString()} / ${p.period}</p>
                        </div>
                    </div>
                `).join('');

                html += `</div>`;
                list.innerHTML += html;
            }
        }

        function renderCards() {
            const container = document.getElementById('cards-container');

            if (cards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-passport"></i>
                        <p>é‚„æ²’æœ‰ç´€éŒ„å–”ï¼<br>é»æ“Šå³ä¸‹è§’ + é–‹å§‹è¦åŠƒä½ çš„æ—¥æ—…æ”»ç•¥</p>
                    </div>
                `;
                return;
            }

            // Build all HTML string first to improve performance
            let fullHtml = '';

            cards.forEach((card, index) => {
                const percent = (card.current / card.limit) * 100;
                let colorVar = '--primary';
                if (card.category === 'å‰é¶´å¡') colorVar = '--secondary';
                if (card.category === 'æ˜Ÿå±• eco å¡') colorVar = '--eco';

                let statusText = `é‚„å¯åˆ· $${(card.limit - card.current).toLocaleString()}`;

                if (percent >= 100) {
                    colorVar = '--success'; // é”æ¨™ç”¨ç¶ è‰²
                    statusText = 'ğŸ‰ å·²é”æ¨™ä¸Šé™ï¼';
                } else if (percent >= 80) {
                    colorVar = '--warning';
                }

                // è™•ç†è¶…åˆ·é¡¯ç¤º
                const isOver = card.current > card.limit;
                if (isOver) {
                    colorVar = '--text-sub'; // è¶…åˆ·è®Šç°
                    statusText = `è¶…åˆ· $${(card.current - card.limit).toLocaleString()} (å›é¥‹ç‡é™ä½)`;
                }

                // Emoji Icon
                let catIcon = 'ğŸ’³';
                if (card.category === 'ç†Šæœ¬ç†Šå¡') catIcon = 'ğŸ»';
                else if (card.category === 'å‰é¶´å¡') catIcon = 'ğŸª¿';
                else if (card.category === 'æ˜Ÿå±• eco å¡') catIcon = 'ğŸŒ±';

                const html = `
                    <div class="card-target" data-type="${card.category || 'å…¶ä»–'}">
                        <div class="card-header">
                            <div class="card-title-group">
                                <div class="card-type-label">
                                    ${catIcon}
                                    ${card.category || 'å…¶ä»–'} 
                                    <span class="period-tag" style="margin-left:4px;">${card.period}</span>
                                </div>
                                <div class="card-title">${card.name}</div>
                            </div>
                            <div class="delete-btn" onclick="deleteCard(${index})">
                                <i class="fas fa-trash-alt"></i>
                            </div>
                        </div>

                        <div class="current-spend"><span class="currency">$</span>${parseInt(card.current).toLocaleString()}</div>

                        <div class="progress-section">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(percent, 100)}%; background-color: var(${colorVar});"></div>
                            </div>
                            <div class="stats-row">
                                <span style="color:var(${colorVar})">${Math.min(percent, 100).toFixed(1)}%</span>
                                <span style="font-size:13px; color:#6B7280;">${statusText}</span>
                            </div>
                        </div>

                        ${card.note ? `
                        <div class="advisor-note">
                            <strong><i class="fas fa-lightbulb" style="color:#F59E0B"></i> æ”»ç•¥ç­†è¨˜ï¼š</strong>
                            ${card.note}
                        </div>
                        ` : ''}

                        <div class="action-row">
                            <input type="number" id="amount-${index}" class="amount-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric" onkeydown="if(event.key==='Enter'){updateCard(${index}, 1); this.blur();}">
                            <button class="btn btn-add" onclick="updateCard(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sub" onclick="updateCard(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                `;
                fullHtml += html;
            });

            container.innerHTML = fullHtml;
        }

        function addPreset(category, name, limit, period, note) {
            cards.push({
                category,
                name,
                limit,
                period,
                note,
                current: 0,
                id: Date.now()
            });
            saveCards();
            closeAddModal();
        }

        function addCustomCard() {
            const category = document.getElementById('input-category').value;
            const name = document.getElementById('input-name').value.trim();
            const limit = parseInt(document.getElementById('input-limit').value);
            const period = document.getElementById('input-period').value;
            const note = document.getElementById('input-note').value.trim();

            if (!name || isNaN(limit) || limit <= 0) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„åç¨±èˆ‡ä¸Šé™é‡‘é¡');
                return;
            }

            cards.push({
                category,
                name,
                limit,
                period,
                note,
                current: 0,
                id: Date.now()
            });

            saveCards();
            closeAddModal();

            // Clear inputs
            document.getElementById('input-name').value = '';
            document.getElementById('input-limit').value = '';
            document.getElementById('input-note').value = '';
        }

        function deleteCard(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ”»ç•¥ç›®æ¨™å—ï¼Ÿ')) {
                cards.splice(index, 1);
                saveCards();
            }
        }

        function updateCard(index, multiplier) {
            const input = document.getElementById(`amount-${index}`);
            const val = Number(input.value); // Better than parseInt for safety

            if (isNaN(val) || val <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
                return;
            }

            // Safety check for data integrity
            if (typeof cards[index].current !== 'number') {
                cards[index].current = parseFloat(cards[index].current) || 0;
            }

            // Update
            cards[index].current += val * multiplier;
            if (cards[index].current < 0) cards[index].current = 0;

            saveCards(); // saveCards calls renderCards, which refreshes the input ID
        }

        // --- Settings / Backup Logic ---
        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'flex';
            initSettingsUI(); // Load API Key
            // Populate export area
            const data = JSON.stringify(cards);
            document.getElementById('export-area').value = data;
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function copyExportData() {
            const copyText = document.getElementById("export-area");
            copyText.select();
            copyText.setSelectionRange(0, 99999); // For mobile devices

            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(copyText.value).then(() => {
                    alert("ä»£ç¢¼å·²è¤‡è£½ï¼è«‹ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹ã€‚");
                });
            } else {
                // Fallback
                document.execCommand("copy");
                alert("ä»£ç¢¼å·²è¤‡è£½ï¼è«‹ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹ã€‚");
            }
        }

        function importData() {
            const input = document.getElementById('import-input').value.trim();
            if (!input) return alert("è«‹è²¼ä¸Šå‚™ä»½ä»£ç¢¼");

            try {
                const data = JSON.parse(input);
                if (Array.isArray(data)) {
                    if (confirm("ç¢ºå®šè¦è¼‰å…¥å‚™ä»½å—ï¼Ÿé€™å°‡æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ï¼")) {
                        cards = data;
                        saveCards();
                        alert("è³‡æ–™é‚„åŸæˆåŠŸï¼");
                        closeSettingsModal();
                        document.getElementById('import-input').value = '';
                    }
                } else {
                    alert("æ ¼å¼éŒ¯èª¤ï¼šä»£ç¢¼ç„¡æ•ˆ");
                }
            } catch (e) {
                alert("æ ¼å¼éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ä»£ç¢¼æ˜¯å¦å®Œæ•´");
            }
        }

        function clearAllData() {
            if (confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                cards = [];
                saveCards();
                closeSettingsModal();
            }
        }

        // --- Gemini AI Logic ---

        async function askGemini() {
            const input = document.getElementById('ai-input');
            const responseArea = document.getElementById('ai-response-area');
            const query = input.value.trim();

            if (!query) return;

            // 1. Show User Message
            responseArea.innerHTML += `<div class="ai-message user">${query}</div>`;
            input.value = '';

            // 2. Show Loading
            const loadingId = 'loading-' + Date.now();
            responseArea.innerHTML += `<div class="ai-message bot" id="${loadingId}">æ€è€ƒä¸­<span class="loading-dots"></span></div>`;
            responseArea.scrollTop = responseArea.scrollHeight;

            try {
                // Construct Prompt
                const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ—¥æ—…ä¿¡ç”¨å¡ç†è²¡é¡§å•ï¼Œå°ˆç²¾æ–¼ã€Œç‰å±±ç†Šæœ¬ç†Šå¡ã€ã€ã€Œè¯é‚¦å‰é¶´å¡ã€èˆ‡ã€Œæ˜Ÿå±• eco æ°¸çºŒæ¥µç°¡å¡ã€ã€‚
                ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šç”¨æˆ¶ç›®å‰çš„ã€Œç´¯ç©æ¶ˆè²»ç‹€æ…‹ã€(State) ä»¥åŠä»–å€‘çš„ã€Œè³¼ç‰©è¨ˆç•«ã€(Query)ï¼Œæä¾›ç²¾æº–çš„å»ºè­°ã€‚
                
                2026å¹´(ä¸ŠåŠå¹´)å¡ç‰‡è¦å‰‡é‡é»ï¼š
                
                ã€ğŸ» ç‰å±±ç†Šæœ¬ç†Šå¡ (JCB)ã€‘
                1. æ—¥æœ¬æŒ‡å®šé€šè·¯(BicCamera, æ¾æœ¬æ¸…, Suicaå„²å€¼ç­‰) åŠ ç¢¼6% (ç¸½å…±8.5%)ã€‚åŠ ç¢¼éƒ¨åˆ†ä¸Šé™500å…ƒå°å¹£/æœˆ (ç´„åˆ·8333å°å¹£)ã€‚
                2. æ—¥æœ¬PayPayæƒç¢¼ (ç¶å®šWallet) åŠ ç¢¼3.5% (ç¸½å…±5%)ã€‚åŠ ç¢¼éƒ¨åˆ†ä¸Šé™100å…ƒå°å¹£/å­£ (ç´„åˆ·2857å°å¹£)ã€‚æ³¨æ„æ˜¯æ¯å­£ã€‚
                3. ä¸€èˆ¬æ¶ˆè²» 2.5% ç„¡ä¸Šé™ã€‚

                ã€ğŸª¿ è¯é‚¦å‰é¶´å¡ã€‘
                1. æ—¥æœ¬ Apple Pay (QUICPay) ç™»éŒ„åŠ ç¢¼ 1.5% (ç¸½å…±4%)ã€‚åŠ ç¢¼ä¸Šé™ 600å…ƒ/æœˆ (ç´„åˆ· 40,000å°å¹£)ã€‚
                2. åœ‹å…§æ—¥ç³»ååº— (UNIQLO/DAISOç­‰) åŠ ç¢¼ 4% (ç¸½å…±5%)ã€‚åŠ ç¢¼ä¸Šé™ 500å…ƒ/æœˆ (ç´„åˆ· 12,500å°å¹£)ã€‚
                3. æ—¥æœ¬ç†±é–€å•†åº— (è¶…å•†/è—¥å¦/æ¨‚åœ’) åŠ ç¢¼ 3%ã€‚æ³¨æ„ä¸Šé™æ˜¯ã€Œæ´»å‹•æœŸé–“(åŠå¹´) 600å…ƒã€ï¼Œä»£è¡¨åŠå¹´åªèƒ½åˆ· 20,000å…ƒã€‚
                4. æ—¥å¹£ä¸€èˆ¬æ¶ˆè²» 2.5% ç„¡ä¸Šé™ã€‚

                ã€ğŸŒ± æ˜Ÿå±• eco æ°¸çºŒæ¥µç°¡å¡ã€‘
                1. æ—¥æœ¬å¯¦é«”æ¶ˆè²» (å« Apple Pay) äº« 5% å›é¥‹ã€‚
                2. åŠ ç¢¼ 4% ä¸Šé™ 600 é»/æœŸï¼Œä»£è¡¨åˆ· 15,000 å°å¹£é”ä¸Šé™ã€‚
                3. è¶…éå¾Œå›æ­¸ 1% ç„¡ä¸Šé™ã€‚
                4. åƒ…é™å¯¦é«”äº¤æ˜“ï¼Œç¶²è·¯/è¨‚æˆ¿ä¸é©ç”¨ã€‚

                ç”¨æˆ¶ç›®å‰ç‹€æ…‹ JSON: ${JSON.stringify(cards)}
                (æ³¨æ„: 'limit'æ˜¯è©²é¡åˆ¥çš„ä¸Šé™é¡åº¦, 'current'æ˜¯ç›®å‰å·²ç”¨é‡‘é¡ã€‚å–®ä½çš†ç‚ºå°å¹£ TWD)

                è«‹ç›´æ¥å›ç­”ç”¨æˆ¶å•é¡Œã€‚
                1. è‹¥ç”¨æˆ¶è©¢å•åˆ·å“ªå¼µå¡ï¼Œè«‹æ¯”è¼ƒå…©è€…å›é¥‹ç‡èˆ‡å‰©é¤˜é¡åº¦ã€‚
                2. è‹¥æ¶‰åŠæ—¥å¹£ï¼Œè«‹ç”¨åŒ¯ç‡(ç´„0.22)æ›ç®—ã€‚
                3. å„ªå…ˆæ¨è–¦å›é¥‹ç‡é«˜ä¸”é‚„æœ‰é¡åº¦çš„å¡ç‰‡ã€‚
                å›ç­”è«‹ç°¡çŸ­ã€å‹å–„ã€‚
                `;

                // Call API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: query }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // 3. Update UI
                const loadingEl = document.getElementById(loadingId);
                loadingEl.innerText = aiText;

            } catch (e) {
                console.error(e);
                document.getElementById(loadingId).innerText = "æŠ±æ­‰ï¼ŒAI ç›®å‰é€£ç·šä¸ç©©ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }

        // UI Helpers
        function openAddModal() {
            document.getElementById('add-modal').style.display = 'flex';
        }
        function closeAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        function openAIModal() {
            document.getElementById('ai-modal').style.display = 'flex';
            document.getElementById('ai-input').focus();
        }
        function closeAIModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        // Close modal on outside click
        document.getElementById('add-modal').addEventListener('click', function (e) {
            if (e.target === this) closeAddModal();
        });
        document.getElementById('ai-modal').addEventListener('click', function (e) {
            if (e.target === this) closeAIModal();
        });
        document.getElementById('settings-modal').addEventListener('click', function (e) {
            if (e.target === this) closeSettingsModal();
        });
    </script>
>>>>>>> 35505d92eda3e38170e39b884881a0476f1cf2b0
</body>

</html>